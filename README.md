# PBG87 Backend API

This is the backend API for the PBG Class 87 Alumni Portal.

## Features

- User authentication and authorization
- Member profile management
- File upload (avatars)
- RESTful API endpoints
- PostgreSQL/SQLite database support
- CORS configuration for frontend integration

## Environment Variables

### Required Environment Variables

- `DATABASE_URL`: Database connection string (PostgreSQL for production, SQLite for development)
- `SECRET_KEY`: Secret key for JWT token generation
- `ALGORITHM`: JWT algorithm (default: HS256)
- `ACCESS_TOKEN_EXPIRE_MINUTES`: Token expiration time in minutes (default: 30)

### Optional Environment Variables

- `ENVIRONMENT`: Environment name (development/production)
- `FRONTEND_URL`: Frontend URL for CORS
- `CORS_ORIGINS`: Comma-separated list of allowed CORS origins

## Local Development

### Prerequisites

- Python 3.11+
- pip

### Quick Start

1. **Using the development script (recommended):**
   ```bash
   python scripts/dev-setup.py
   ```

2. **Manual setup:**
   ```bash
   # Install dependencies
   pip install -r requirements.txt
   
   # Set environment variables
   export ENVIRONMENT=development
   export DATABASE_URL=sqlite:///./app.db
   export SECRET_KEY=dev-secret-key
   
   # Initialize database
   python startup.py
   
   # Start server
   python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000
   ```

### API Endpoints

- **Health Check**: `GET /health`
- **API Documentation**: `GET /docs` (Swagger UI)
- **User Registration**: `POST /api/users/register`
- **User Login**: `POST /api/users/token`
- **User Profile**: `GET /api/users/profile`
- **Avatar Upload**: `POST /api/upload/avatar`

## Production Deployment

### Render.com Deployment

The backend is configured for automatic deployment on Render.com using the `render.yaml` file.

#### Deployment Steps:

1. **Connect Repository**: Connect your GitHub repository to Render
2. **Environment Variables**: Set the following environment variables in Render:
   - `DATABASE_URL`: PostgreSQL connection string (auto-generated by Render)
   - `SECRET_KEY`: Secure random string
   - `ALGORITHM`: HS256
   - `ACCESS_TOKEN_EXPIRE_MINUTES`: 30
   - `FRONTEND_URL`: https://pbg.vercel.app
   - `CORS_ORIGINS`: https://pbg.vercel.app,http://localhost:3000,http://localhost:3001
   - `ENVIRONMENT`: production

3. **Deploy**: Render will automatically deploy when you push to the main branch

#### Build Configuration:

- **Build Command**: 
  ```bash
  apt-get update && apt-get install -y gcc g++ libpq-dev
  pip install --upgrade pip
  pip install -r backend/requirements.txt
  ```

- **Start Command**: 
  ```bash
  cd backend && python -m uvicorn main:app --host 0.0.0.0 --port $PORT
  ```

- **Health Check**: `/health`

### Database Setup

The application automatically creates database tables on startup. For production:

1. **PostgreSQL**: Use the DATABASE_URL provided by Render
2. **SQLite**: Used for local development (not recommended for production)

### File Uploads

- **Avatar Uploads**: Stored in `uploads/avatars/` directory
- **File Size Limit**: 5MB
- **Supported Formats**: Images (JPEG, PNG, etc.)

## Configuration

The application uses a centralized configuration system in `config.py` that automatically detects the environment and sets appropriate values.

### Development Configuration:
- Frontend URL: `http://localhost:3000`
- Database: SQLite
- CORS: Local development origins

### Production Configuration:
- Frontend URL: `https://pbg.vercel.app`
- Database: PostgreSQL
- CORS: Production origins

## Troubleshooting

### Common Issues

1. **Database Connection Errors**:
   - Check DATABASE_URL format
   - Ensure database is accessible
   - For PostgreSQL: Verify connection string format

2. **CORS Errors**:
   - Verify CORS_ORIGINS includes your frontend URL
   - Check frontend is making requests to correct backend URL

3. **File Upload Issues**:
   - Ensure upload directory exists and is writable
   - Check file size limits
   - Verify file type is supported

4. **Authentication Issues**:
   - Verify SECRET_KEY is set
   - Check token expiration settings
   - Ensure proper JWT token format

### Logs

- **Local Development**: Check console output
- **Render Deployment**: Check Render logs in the dashboard

## API Documentation

Once the server is running, visit `http://localhost:8000/docs` for interactive API documentation (Swagger UI).

## Security Notes

- Change default SECRET_KEY in production
- Use HTTPS in production
- Regularly update dependencies
- Monitor for security vulnerabilities 